<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daftar BMN - Semua Ruangan (Editable - Fixed)</title>
  <style>
    :root {
      --bg: #0b0e14;
      --card: #111623;
      --text: #e8ecf1;
      --muted: #a9b1bd;
      --accent: #4da3ff;
      --line: #273043;
      --danger: #ff6b6b;
      --success: #4caf50;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    header {
      max-width: 1200px; margin: 0 auto 16px; padding: 18px; background: var(--card); border: 1px solid var(--line); border-radius: 12px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    header .left { flex: 1 1 480px; }
    h1 { margin: 0; font-size: 20px; }
    .meta-line { color: var(--muted); font-size: 13px; margin-top:6px; }
    .controls { display:flex; gap:8px; align-items:center; }
    input[type="search"], input[type="file"] { padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#0f1422; color:var(--text); }
    button, .btn {
      padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#142038; color:var(--text); cursor:pointer;
    }
    main { max-width: 1200px; margin: 18px auto; }
    nav.toc {
      margin-bottom: 18px; padding:12px; background:var(--card); border:1px solid var(--line); border-radius:12px;
    }
    nav.toc h3 { margin:0 0 8px 0; color:var(--muted); font-size:15px; }
    nav.toc ul { list-style:none; margin:0; padding:0; display:flex; flex-wrap:wrap; gap:8px; }
    nav.toc a { color:var(--accent); text-decoration:none; padding:6px 10px; background:#0e1622; border-radius:8px; display:inline-block; border:1px solid var(--line); }
    section {
      background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 12px; margin-bottom: 14px;
    }
    section h2 { margin: 0 0 8px 0; font-size: 16px; }
    .meta { color:var(--muted); font-size:13px; margin-bottom:8px; }
    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse: collapse; }
    thead th { position: sticky; top:0; background:#141b2c; z-index:2; }
    th, td { border-bottom:1px solid var(--line); padding:8px 10px; text-align:left; }
    tbody tr:hover { background:#0f1626; }
    .hidden { display:none !important; }
    form .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    form input, form button { flex: 1 1 160px; }
    .actions button { margin-right:6px; }
    .small { padding:6px 8px; font-size:13px; border-radius:8px; }
    .danger { background:var(--danger); border-color:rgba(255,255,255,0.05); }
    .success { background:var(--success); border-color:rgba(255,255,255,0.05); }
    footer { max-width:1200px; margin:8px auto 40px auto; color:var(--muted); font-size:12px; text-align:center; }
    .utils { display:flex; gap:8px; align-items:center; }
    @media (max-width:640px) {
      header { padding:12px; }
      form input, form button { flex:1 1 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>ðŸ“‹ Daftar BMN â€“ Semua Ruangan </h1>
    </div>
  </header>

  <main id="main-content"></main>

  <footer>File ini dibuat otomatis â€” fitur: tambah / kurangi jumlah / hapus / edit / pencarian / ekspor & impor JSON / perbaikan kurangi.</footer>

  <script>
    // ======= Data default (diambil dari file awal) =======
    const defaultData = {
      "KEPALA_KANTOR": [
        ["AC","Gree","2 Unit"],
        ["Fire Extinguisher","","2 Unit"],
        ["Kursi Futura","Futura","36 Unit"],
        ["Layar Monitor","Sony","1 Unit"],
        ["Meja Kayu","","2 Unit"],
        ["Meja Lipat","Food Crout","8 Unit"],
        ["Meja Sofa","","1 Unit"],
        ["Sofa","","1 Set"],
        ["Speaker","Lexu","4 Unit"]
      ],
      "KASI_TIKIM": [
        ["AC Spilit","SHARP","1 Unit"],
        ["Kursi Futura Merah","Futura","5 Unit"],
        ["Kusi kantor","","1 Unit"],
        ["Lemari arsip Besi","Brother","1 Unit"],
        ["Meja Kantor","","1 Unit"],
        ["Meja Rapat Kantor","","1 Unit"],
        ["Monitor Komputer","ACER","1 Unit"],
        ["Tempat Sampah","","1 Unit"],
        ["Whit board","","1 Unit"],
        ["Speaker","","1 Unit"]
      ],
      "KASI_INFORMASI_&_KOMUNIKASI": [
        ["AC Spilit","SHARP","1 Unit"],
        ["Kursi Futura Merah","Futura","5 Unit"],
        ["Kusi kantor","","1 Unit"],
        ["Lemari arsip Besi","Brother","1 Unit"],
        ["Meja Kantor","","1 Unit"],
        ["Meja Rapat Kantor","","1 Unit"],
        ["Monitor Komputer","ACER","1 Unit"],
        ["Tempat Sampah","","1 Unit"],
        ["Whit board","","1 Unit"],
        ["Speaker","","1 Unit"]
      ],
      "KAUR_UMUM": [
        ["AC","SAMSUNG","1 Unit"],
        ["Brangkas","","1 Unit"],
        ["Kursi Futura Merah","Futura","2 Unit"],
        ["Lemari kabinet","LG","1 Unit"],
        ["Meja kerja","","1 Unit"]
      ],
      "TATA_USAHA": [
        ["AC","SAMSUNG","1 Unit"],
        ["Brangkas","","1 Unit"],
        ["Kursi Futura Merah","Futura","2 Unit"],
        ["Lemari kabinet","LG","1 Unit"],
        ["Meja kerja","","1 Unit"]
      ],
      "KAUR_KEPEGAWAIAN": [
        ["AC","SAMSUNG","1 Unit"],
        ["Brangkas","","1 Unit"],
        ["Kursi Futura Merah","Futura","2 Unit"],
        ["Lemari kabinet","LG","1 Unit"],
        ["Meja kerja","","1 Unit"]
      ],
      "RUANG_RAPAT_KECIL": [
        ["AC","Sharp","1 Unit"],
        ["Kursi Futura Merah","Futura","8 Unit"],
        ["Kursi kerja kantor","Indachi","1 Unit"],
        ["Meja kerja Bundah","Indachi","1 Unit"],
        ["TY SONY","SONY BRAVIA","1 Unit"]
      ],
      "KASUBSI_INTELEJEN": [
        ["Komputer","AIO Hp","1 Unit"],
        ["Kursi Future Merah","Future","2 Unit"],
        ["Kursi Kerja Kantor","Indhaci","1 Unit"],
        ["Meja Kerja Kantor","","2 Unit"],
        ["Rak Penyimpanan Barang","","1 Unit"]
      ],
      "RUANG_PELAYANAN_WNA": [
        ["AC","Samsung","1 Unit"],
        ["Brangkas","i Safe","1 Unit"],
        ["Komputer","Acer","1 Unit"],
        ["Komputer","Axioo","1 Unit"],
        ["Kursi Kerja Kantor","","5 Unit"],
        ["Lemari Arsip Besi","Brother","1 Unit"],
        ["Lemari kaca","","1 Unit"],
        ["Printer","Epson","1 Unit"],
        ["Sceaner","Fujitsu","1 Unit"],
        ["Tempat Sampah","Multindo","1 Unit"]
      ],
      "AULA": [
        ["AC","Panasonic","1 Unit"],
        ["Fire extinguisher","","1 Unit"],
        ["Kursi Futere","Futere","2 Unit"],
        ["Layar Monitor","Sony","1 Unit"],
        ["Meja Kayu","","1 Unit"],
        ["Meja Lipat","Food Crout","1 Unit"],
        ["Meja Sofa","","1 Unit"],
        ["Sofa","","1 Unit"],
        ["Speaker","Lexu","1 Unit"]
      ],
      "RUANG_ISTIRAHAT": [
        ["AC","Polytron","1 Unit"],
        ["Brankas","Lexto","1 Unit"],
        ["Kursi kantor Coklat","Indachi","1 Unit"],
        ["Lemari Arsip Besi","Tiger","1 Unit"],
        ["Sofa Classic","Classic","1 Unit"],
        ["Sound System","Geisler","1 Unit"],
        ["Speakers","BMB","2 Unit"],
        ["Rak Penyimpanan","Classic","1 Unit"]
      ],
      "DAPUR": [
        ["Dispenser","Miyako","1 Unit"],
        ["Freezer","","1 Unit"],
        ["Kulkas","LG","1 Unit"],
        ["Kursi Futura Merah","Futura","2 Unit"],
        ["Kursi Lipat Bangku","","1 Unit"],
        ["Kitchen Shet","","1 Unit"],
        ["Lemari Arsip Besi","Brother","1 Unit"],
        ["Meja Dapur","","1 Unit"],
        ["Meja Makan","Informa","1 Unit"]
      ],
      "KAUR_KEUANGAN": [
        ["AC","Samsung","1 Unit"],
        ["Brankas","Dragon A1 Lk","1 Unit"],
        ["Cermin","","1 Unit"],
        ["Jam Dinding","","1 Unit"],
        ["Komputer AIO","HP","1 Unit"],
        ["Kursi Futura Coklat","Futura","1 Unit"],
        ["Kursi Futura Merah","Futura","2 Unit"],
        ["Kursi Kantor","Indhachi","2 Unit"],
        ["Meja Kerja Kantor","Lunar","1 Unit"],
        ["Meja Kerja Kantor","Vixsion","1 Unit"],
        ["Printer","Epson","1 Unit"],
        ["Rak Penyimpanan","Rafega","1 Unit"],
        ["Rak Penyimpanan Berkas","","2 Unit"],
        ["Tempat Sampah","Shimpo","1 Unit"]
      ],
      "KASI_INTELEJEN_&_PENINDAKAN": [
        ["AC","Sharp","2 Unit"],
        ["Brankas","Dainchi","2 Unit"],
        ["Komputer","Axioo","1 Unit"],
        ["Komputer","Lenovo","1 Unit"],
        ["Kursi Futura Merah","Futura","1 Unit"],
        ["Lemari Arsip","","1 Unit"],
        ["Meja Kerja Kantor","Fujitsu","1 Unit"]
      ],
      "KASUBSI_PENINDAKAN": [
        ["AC","Panasonic","1 Unit"],
        ["Komputer AIO","HP","1 Unit"],
        ["Kursi Futura","Futura","2 Unit"],
        ["Kursi kantor","Preloved","1 Unit"],
        ["Kursi Lipat","Flaken","1 Unit"],
        ["Lemari Arsip","","1 Unit"],
        ["Meja kerja","","1 Unit"],
        ["Meja Kerja Kantor","Higpoint","1 Unit"],
        ["Tempat Sampah","Green Leave","1 Unit"]
      ],
      "RUANG_PENGADUAN": [
        ["AC","Sharp","1 Unit"],
        ["Kursi Futura Merah","Futura","8 Unit"],
        ["Kursi Kerja Kantor","Indachi","1 Unit"],
        ["Meja Kerja","Bundah Indachi","1 Unit"],
        ["TV","Sony Bravia","1 Unit"]
      ],
      "RUANG_PELAYANAN_WNI": [
        ["AC","Sharp","1 Unit"],
        ["Kursi Futura Merah","Futura","8 Unit"],
        ["Kursi Kerja Kantor","Indachi","1 Unit"],
        ["Meja Kerja","Bundah Indachi","1 Unit"],
        ["TV","Sony Bravia","1 Unit"]
      ],
    };

    // ======= Utility: localStorage save/load =======
    const STORAGE_KEY = 'bmn_data_v4';

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return JSON.parse(JSON.stringify(defaultData));
      try {
        const parsed = JSON.parse(raw);
        if (typeof parsed === 'object' && parsed !== null) return parsed;
        return JSON.parse(JSON.stringify(defaultData));
      } catch (err) {
        console.warn('Gagal parse localStorage, memakai default', err);
        return JSON.parse(JSON.stringify(defaultData));
      }
    }

    function saveData(d) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
    }

    // ======= App state =======
    let data = loadData();

    // ======= Render functions =======
    function render() {
      const main = document.getElementById('main-content');
      main.innerHTML = '';

      // Table of contents
      const toc = document.createElement('nav');
      toc.className = 'toc';
      toc.innerHTML = `<h3>Daftar Ruangan</h3><ul></ul>`;
      const ul = toc.querySelector('ul');
      Object.keys(data).forEach(room => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + encodeURIComponent(room);
        a.innerText = room.replace(/_/g,' ');
        li.appendChild(a);
        ul.appendChild(li);
      });
      main.appendChild(toc);

      Object.keys(data).forEach(room => {
        const section = document.createElement('section');
        section.id = room;
        const count = data[room].length;
        section.innerHTML = `
          <h2>Ruangan: ${room.replace(/_/g,' ')}</h2>
          <div class="meta">Jumlah entri: <span id="count-${room}">${count}</span></div>
          <form onsubmit="addItem(event,'${room}')">
            <div class="controls">
              <input name="barang" placeholder="Nama Barang" required />
              <input name="merk" placeholder="Merk" />
              <input name="jumlah" placeholder="Jumlah (contoh: 2 Unit)" required />
              <button type="submit">âž• Tambah</button>
            </div>
          </form>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Nama Barang</th><th>Merk</th><th>Jumlah</th><th style="width:220px">Aksi</th></tr>
              </thead>
              <tbody id="tbody-${room}"></tbody>
            </table>
          </div>
          <a class="back-top" href="#top" style="display:inline-block;margin-top:10px;color:var(--accent);text-decoration:none">â¬† Kembali ke atas</a>
        `;
        main.appendChild(section);
        updateTable(room);
      });
    }

    function updateTable(room) {
      const tbody = document.getElementById('tbody-' + room);
      const countEl = document.getElementById('count-' + room);
      tbody.innerHTML = '';
      data[room].forEach((row, i) => {
        const tr = document.createElement('tr');
        const nama = escapeHtml(row[0]||'');
        const merk = escapeHtml(row[1]||'');
        const jumlah = escapeHtml(row[2]||'');
        tr.innerHTML = `
          <td>${nama}</td>
          <td>${merk}</td>
          <td id="q-${room}-${i}">${jumlah}</td>
          <td class="actions">
            <button class="small" onclick="decreaseQty('${room}',${i})">âˆ’</button>
            <button class="small" onclick="increaseQty('${room}',${i})">+</button>
            <button class="small danger" onclick="deleteRow('${room}',${i})">ðŸ—‘ Hapus</button>
          </td>`;
        tbody.appendChild(tr);
      });
      if (countEl) countEl.innerText = data[room].length;
      saveData(data);
    }

    // ======= CRUD ops =======
    function addItem(e, room) {
      e.preventDefault();
      const form = e.target;
      const barang = form.barang.value.trim();
      const merk = form.merk.value.trim();
      const jumlah = form.jumlah.value.trim();
      if (!barang || !jumlah) return alert('Isi nama barang dan jumlah.');
      data[room].push([barang, merk, jumlah]);
      form.reset();
      updateTable(room);
    }

    function deleteRow(room, i) {
      if (!confirm('Hapus item ini?')) return;
      data[room].splice(i,1);
      updateTable(room);
    }

    function editRow(room, i) {
      const item = data[room][i];
      const barang = prompt('Nama Barang:', item[0]);
      if (barang === null) return; // batal
      const merk = prompt('Merk:', item[1]);
      if (merk === null) return;
      const jumlah = prompt('Jumlah:', item[2]);
      if (jumlah === null) return;
      item[0] = barang.trim();
      item[1] = merk.trim();
      item[2] = jumlah.trim();
      updateTable(room);
    }

    function copyRow(room, i) {
      const item = data[room][i];
      const text = `${item[0]} | ${item[1]} | ${item[2]}`;
      navigator.clipboard?.writeText(text).then(()=>{
        alert('Tersalin ke clipboard:\n' + text);
      }).catch(()=>{
        prompt('Salin teks berikut:', text);
      });
    }

    // ======= Quantity helpers (tambah / kurangi) =======
    function parseQty(q) {
      // Perbaikan parsing:
      // - cari angka pertama (boleh pakai koma atau titik desimal)
      // - biarkan unit persis seperti aslinya (jika ada), jangan default ke "Unit"
      const s = String(q).trim();
      const m = s.match(/-?\d+(?:[.,]\d+)?/);
      if (m) {
        const numStr = m[0].replace(',', '.');
        const n = parseFloat(numStr);
        const after = s.slice(m.index + m[0].length).trim();
        // preserve unit exactly as typed (could be empty string)
        const unit = after;
        return { n: isNaN(n) ? 0 : n, unit };
      }
      // tidak ada angka sama sekali -> treat as 0 with original text as unit
      return { n: 0, unit: s };
    }

    function formatQty(n, unit) {
      // Jika unit ada, tambahkan spasi; jika tidak, tampilkan hanya angka
      // Jika n integer, tampilkan tanpa desimal tambahan
      if (Number.isInteger(n)) {
        return unit ? `${n} ${unit}` : `${n}`;
      } else {
        // tampilkan angka dengan maksimal 2 desimal
        const fixed = Math.round(n * 100) / 100;
        return unit ? `${fixed} ${unit}` : `${fixed}`;
      }
    }

    function increaseQty(room, i) {
      const item = data[room][i];
      const q = parseQty(item[2]);
      // jika item[2] tidak berisi angka, treat as 0 and keep unit
      const newN = q.n + 1;
      item[2] = formatQty(newN, q.unit);
      updateTable(room);
    }

    function decreaseQty(room, i) {
      const item = data[room][i];
      const q = parseQty(item[2]);
      let newN = q.n - 1;
      if (newN < 0) newN = 0;
      item[2] = formatQty(newN, q.unit);
      updateTable(room);
    }

    // ======= Helpers: escape html =======
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(m){ return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

    // ======= Init =======
    window.addEventListener('load', () => {
      if (!localStorage.getItem(STORAGE_KEY)) saveData(defaultData);
      render();
    });
  </script>
</body>
</html>
