<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daftar BMN - Semua Ruangan</title>
  <!-- Sertakan library jsPDF dan jsPDF-AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
  <style>
    /* Variabel CSS untuk Tema Terang */
    :root {
      --bg: #f0f2f5; /* Latar belakang sangat terang */
      --card: #ffffff; /* Latar belakang kartu putih */
      --text: #333333; /* Teks gelap */
      --muted: #666666; /* Teks muted lebih gelap */
      --accent: #007bff; /* Aksen biru standar */
      --line: #dddddd; /* Garis abu-abu terang */
      --danger: #dc3545; /* Merah standar (tetap didefinisikan, tapi tidak digunakan untuk background tombol hapus) */
      --success: #28a745; /* Hijau standar */
    }

    /* Reset dan Gaya Dasar */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }

    /* Header */
    header {
      max-width: 1200px; margin: 0 auto 16px; padding: 18px; background: var(--card); border: 1px solid var(--line); border-radius: 12px;
      display:flex;
      gap: 20px; /* Menambah gap antar elemen di header */
      align-items:center;
      justify-content: space-between; /* Mengubah kembali menjadi space-between */
      flex-wrap:wrap;
    }
    header .left {
      flex-grow: 1; /* Memungkinkan elemen ini mengisi ruang kosong */
      flex-shrink: 0;
    }
    h1 { margin: 0; font-size: 20px; }
    .meta-line { color: var(--muted); font-size: 13px; margin-top:6px; }
    .controls {
      display:flex;
      gap:8px; /* Mengurangi gap untuk kerapian di layar kecil */
      align-items:center;
      flex-wrap: wrap; /* Memastikan kontrol wrap di layar kecil */
      flex-shrink: 0; /* Mencegah elemen ini menyusut terlalu banyak */
    }

    /* Input Fields */
    input[type="search"], input[type="file"] {
      padding:8px 10px; border-radius:10px; border:1px solid var(--line);
      background:#ffffff; /* Latar belakang input putih */
      color:var(--text); /* Teks input gelap */
    }

    /* Buttons */
    button, .btn {
      padding:8px 10px; border-radius:10px; border:1px solid var(--line);
      background:#e9ecef; /* Latar belakang tombol abu-abu muda */
      color:var(--text); /* Teks tombol gelap */
      cursor:pointer;
      white-space: nowrap; /* Mencegah teks tombol pecah baris */
    }

    /* Main Content Area */
    main { max-width: 1200px; margin: 18px auto; }

    /* Table of Contents (TOC) Navigation */
    nav.toc {
      margin-bottom: 18px; padding:12px; background:var(--card); border:1px solid var(--line); border-radius:12px;
    }
    nav.toc h3 {
      margin:0 0 8px 0;
      color: #000000;
      font-size:15px;
      font-weight: bold;
    }
    nav.toc ul { list-style:none; margin:0; padding:0; display:flex; flex-wrap:wrap; gap:8px; }
    nav.toc a {
      color:var(--accent); text-decoration:none; padding:6px 10px;
      background:#e2e6ea;
      border-radius:8px; display:inline-block; border:1px solid var(--line);
    }

    /* Section Styling (for each room) */
    section {
      background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 12px; margin-bottom: 14px;
    }
    section h2 { margin: 0 0 8px 0; font-size: 16px; }
    .meta { color:var(--muted); font-size:13px; margin-bottom:8px; }

    /* Table Styling */
    .table-wrap { overflow-x:auto; } /* Ini yang akan membuat tabel bisa discroll horizontal di layar kecil */
    table { width:100%; border-collapse: collapse; }
    thead th {
      position: sticky; top:0;
      background:#e9ecef;
      z-index:2;
      text-align: center;
    }
    th, td { border-bottom:none; padding:8px 10px; text-align:left; }
    tbody tr:hover {
      background:#f8f9fa;
    }

    /* Utility Classes */
    .hidden { display:none !important; }
    form .controls {
      display:flex;
      gap:8px; /* Mengurangi gap untuk kerapian di layar kecil */
      flex-wrap:wrap;
      margin-bottom:8px;
      justify-content: flex-start;
    }
    form input, form button {
      flex: 1; /* Mengisi ruang yang tersedia secara merata */
      min-width: 120px; /* Menambahkan min-width agar tidak terlalu kecil */
    }
    .actions {
      display: flex;
      gap: 6px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap; /* Memungkinkan tombol untuk wrap ke baris baru jika ruang tidak cukup */
    }
    .actions button {
      margin-right: 0;
      min-width: 70px; /* Menetapkan min-width yang sama untuk semua tombol aksi */
      flex: 1 1 auto; /* Memungkinkan tombol untuk menyesuaikan lebar */
    }
    .small { padding:6px 8px; font-size:13px; border-radius:8px; }
    .danger {
      background:#e9ecef;
      border-color:rgba(0,0,0,0.05);
      color: #000000;
    }
    .success { background:var(--success); border-color:rgba(0,0,0,0.05); }

    /* Footer */
    footer { max-width:1200px; margin:8px auto 40px auto; color:var(--muted); font-size:12px; text-align:center; }
    .utils { display:flex; gap:8px; align-items:center; }

    /* Responsive Design */
    @media (max-width:640px) {
      body { padding: 10px; } /* Mengurangi padding body di layar sangat kecil */
      header { padding:12px; flex-direction: column; align-items: flex-start; } /* Header menjadi kolom */
      header .controls { width: 100%; justify-content: center; margin-top: 10px; } /* Kontrol header mengisi lebar penuh */
      header .controls input, header .controls button { flex: 1 1 100%; } /* Input dan tombol header mengisi lebar penuh */

      form input, form button { flex:1 1 100%; } /* Pada layar kecil, biarkan mereka mengisi 100% */
      nav.toc ul { flex-direction: column; } /* Mengubah daftar TOC menjadi kolom */
      nav.toc a { width: 100%; text-align: center; } /* Memastikan link TOC mengisi lebar penuh */

      /* Penyesuaian untuk kolom aksi di HP */
      td.actions {
        padding-left: 6px;
        text-align: center;
        display: flex;
        flex-direction: column; /* Tombol akan menumpuk secara vertikal */
        justify-content: center;
        gap: 4px; /* Mengurangi gap antar tombol */
        min-width: 80px; /* Memberikan min-width agar tidak terlalu sempit */
      }
      td.actions button {
        width: 100%; /* Tombol mengisi lebar penuh dari td.actions */
        min-width: unset; /* Reset min-width agar width: 100% bekerja */
      }
    }

    /* Print Styles */
    @media print {
      @page {
        size: A4 portrait;
        margin: 15mm;
        @bottom-center {
          content: counter(page);
          font-size: 10pt;
          font-family: "Times New Roman", Times, serif;
        }
      }
      body {
        background: #fff !important;
        color: #000 !important;
        font-size: 11pt !important;
      }
      header, footer, .controls, .back-top, button#printBtn {
        display: none !important;
      }
      header {
        display: block !important;
        background: #fff !important;
        color: #000 !important;
        border: none !important;
        margin-bottom: 20px !important;
        text-align: center !important;
      }
      header h1 {
        font-size: 18pt !important;
        font-weight: bold !important;
        margin: 0 0 20px 0 !important;
      }
      nav.toc {
        display: block !important;
        margin-bottom: 20px !important;
      }
      #main-content section {
        margin-bottom: 8px !important;
        page-break-inside: avoid;
      }
      table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin-bottom: 15px !important;
        table-layout: fixed !important;
      }
      th, td {
        border: 2px solid #000 !important;
        background-color: #ffffff !important;
        padding: 6px 10px !important;
        line-height: 1.4 !important;
        vertical-align: top !important;
        word-wrap: break-word !important;
      }
      th {
        background: #e6e6e6 !important;
        font-weight: bold !important;
        text-align: center !important;
      }
      /* Kolom Aksi adalah th/td ke-5 */
      table tr > th:nth-child(5),
      table tr > td:nth-child(5) {
        display: none !important; /* Menyembunyikan kolom Aksi saat print */
      }
      /* Menyesuaikan lebar kolom untuk print setelah kolom aksi dihapus */
      td:nth-child(3) { /* Kolom Jumlah */
        text-align: center !important;
      }
      td:nth-child(4) { /* Kolom Nomor Barang */
        text-align: center !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>üìã Daftar BMN ‚Äì Semua Ruangan </h1>
    </div>
    <div class="controls">
      <input type="search" id="searchBox" placeholder="üîç Cari barang..." />
      <button onclick="printPage()">üñ® Cetak</button>
      <button onclick="downloadPdf()">‚¨áÔ∏è Unduh PDF</button>
    </div>
  </header>

  <main id="main-content"></main>

  <footer>Kantor Imigrasi Kelas II TPI Sorong</footer>

  <script>
    // ======= Data default (diambil dari file awal) =======
    const defaultData = {
      "KEPALA_KANTOR": [
        ["AC","Gree","2 Unit", "BMN-KK-001"],
        ["Fire Extinguisher","","2 Unit", "BMN-KK-002"],
        ["Kursi Futura","Futura","36 Unit", "BMN-KK-003"],
        ["Layar Monitor","Sony","1 Unit", "BMN-KK-004"],
        ["Meja Kayu","","2 Unit", "BMN-KK-005"],
        ["Meja Lipat","Food Crout","8 Unit", "BMN-KK-006"],
        ["Meja Sofa","","1 Unit", "BMN-KK-007"],
        ["Sofa","","1 Set", "BMN-KK-008"],
        ["Speaker","Lexu","4 Unit", "BMN-KK-009"]
      ],
      "KASI_TIKIM": [
        ["AC Spilit","Sharp","1 Unit", "BMN-KT-001"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-KT-002"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-KT-003"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-KT-004"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-KT-005"],
        ["Kursi Kerja","Indachi","1 Unit", "BMN-KT-006"],
        ["Kursi Kerja","Donati","1 Unit", "BMN-KT-007"],
        ["Lemari arsip Besi","Brother","1 Unit", "BMN-KT-008"],
        ["Meja Kantor","Fantasi","1 Unit", "BMN-KT-009"],
        ["Meja Rapat Kantor","Brother","1 Unit", "BMN-KT-010"],
        ["Monitor Komputer","ACER","1 Unit", "BMN-KT-0011"],
        ["Tempat Sampah","","1 Unit", "BMN-KT-012"],
        ["Whit board","","1 Unit", "BMN-KT-013"],
        ["Speaker","","1 Unit", "BMN-KT-014"]
      ],
      "KAUR_UMUM": [
        ["Komputer","Axioo","1 Unit", "BMN-KU-001"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-KU-002"],
        ["Kursi Kerja Kantor","Indachi","2 Unit", "BMN-KU-003"],
        ["Lemari Arsip besi","","1 Unit", "BMN-KU-004"],
        ["Meja Kerja Kantor","","1 Unit", "BMN-KU-005"]
      ],
      "TATA_USAHA": [
        ["AC","Polytron","1 Unit", "BMN-TU-001"],
        ["Brankas","Indachi","1 Unit", "BMN-TU-002"],
        ["Brankas","Indachi","1 Unit", "BMN-TU-003"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-TU-004"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-TU-005"],
        ["Lemari Besi","LG","1 Unit", "BMN-TU-006"],
        ["Lemari Kabinet","LG","1 Unit", "BMN-TU-007"],
        ["Meja Kerja","","1 Unit", "BMN-TU-008"]
      ],
      "KAUR_KEPEGAWAIAN": [
        ["AC","Samsung","1 Unit", "BMN-KKP-001"],
        ["Brankas","","1 Unit", "BMN-KKP-002"],
        ["Kursi Futura Merah","Futura","2 Unit", "BMN-KKP-003"],
        ["Lemari kabinet","LG","1 Unit", "BMN-KKP-004"],
        ["Meja kerja","","1 Unit", "BMN-KKP-005"],
        ["Rak Besi","Lion","1 Unit", "BMN-KKP-006"]
      ],
      "RUANG_RAPAT": [
        ["AC","Sharp","1 Unit", "BMN-RR-001"],
        ["Kursi Futura Merah","Futura","8 Unit", "BMN-RR-002"],
        ["Kursi kerja kantor","Indachi","1 Unit", "BMN-RR-003"],
        ["Meja kerja Bundah","Indachi","1 Unit", "BMN-RR-004"],
        ["TV SONY","SONY BRAVIA","1 Unit", "BMN-RR-005"]
      ],
      "KASUBSI_INTELEJEN": [
        ["Komputer AIO","Hp","1 Unit", "BMN-KI-001"],
        ["Kursi Future Merah","Future","2 Unit", "BMN-KI-002"],
        ["Kursi Kerja Kantor","Indhaci","1 Unit", "BMN-KI-003"],
        ["Meja Kerja Kantor","","2 Unit", "BMN-KI-004"],
        ["Rak Penyimpanan Barang","","1 Unit", "BMN-KI-005"]
      ],
      "RUANG_PELAYANAN_WNA": [
        ["AC","Samsung","1 Unit", "BMN-RPW-001"],
        ["Brankas","i Safe","1 Unit", "BMN-RPW-002"],
        ["Komputer","Acer","1 Unit", "BMN-RPW-003"],
        ["Komputer","Axioo","1 Unit", "BMN-RPW-004"],
        ["Kursi Kerja Kantor","","5 Unit", "BMN-RPW-005"],
        ["Lemari Arsip Besi","Brother","1 Unit", "BMN-RPW-006"],
        ["Lemari kaca","","1 Unit", "BMN-RPW-007"],
        ["Printer","Epson L5290","1 Unit", "BMN-RPW-008"],
        ["Sceaner","Fujitsu","1 Unit", "BMN-RPW-009"],
        ["Tempat Sampah","Multindo","1 Unit", "BMN-RPW-010"]
      ],
      "AULA": [
        ["AC","Gree","2 Unit", "BMN-A-001"],
        ["Fire extinguisher","","2 Unit", "BMN-A-002"],
        ["Kursi Futere","Futere","36 Unit", "BMN-A-003"],
        ["Layar Monitor","Sony","1 Unit", "BMN-A-004"],
        ["Meja Kayu","","2 Unit", "BMN-A-005"],
        ["Meja Lipat","Food Crout","8 Unit", "BMN-A-006"],
        ["Meja Sofa","","1 Unit", "BMN-A-007"],
        ["Sofa","","1 Set", "BMN-A-008"],
        ["Speaker","Lexu","4 Unit", "BMN-A-009"]
      ],
      "RUANG_ISTIRAHAT": [
        ["AC","Polytron","1 Unit", "BMN-RI-001"],
        ["Brankas","Lexto","1 Unit", "BMN-RI-002"],
        ["Kursi kantor Coklat","Indachi","1 Unit", "BMN-RI-003"],
        ["Lemari Arsip Besi","Tiger","1 Unit", "BMN-RI-004"],
        ["Sofa Classic","Classic","1 Set", "BMN-RI-005"],
        ["Sound System","Geisler","1 Unit", "BMN-RI-006"],
        ["Speakers","BMB","2 Unit", "BMN-RI-007"],
        ["Rak Penyimpanan","","1 Unit", "BMN-RI-008"]
      ],
      "DAPUR": [
        ["Dispenser","Miyako","1 Unit", "BMN-D-001"],
        ["Freezer","","1 Unit", "BMN-D-002"],
        ["Kulkas","LG","1 Unit", "BMN-D-003"],
        ["Kursi Futura Merah","Futura","2 Unit", "BMN-D-004"],
        ["Kursi Lipat Bangku","","1 Unit", "BMN-D-005"],
        ["Kitchen Shet","","1 Unit", "BMN-D-006"],
        ["Lemari Arsip Besi","Brother","1 Unit", "BMN-D-007"],
        ["Meja Dapur","","1 Unit", "BMN-D-008"],
        ["Meja Makan","Informa","1 Unit", "BMN-D-009"]
      ],
      "KAUR_KEUANGAN": [
        ["AC","Samsung","1 Unit", "BMN-KKG-001"],
        ["Brankas","Dragon A1 Lk","1 Unit", "BMN-KKG-002"],
        ["Cermin","","1 Unit", "BMN-KKG-003"],
        ["Jam Dinding","","1 Unit", "BMN-KKG-004"],
        ["Komputer","Axioo","1 Unit", "BMN-KKG-005"],
        ["Komputer AIO","HP","1 Unit", "BMN-KKG-006"],
        ["Kursi Futura Merah","Futura","2 Unit", "BMN-KKG-007"],
        ["Kursi Kantor","Indhachi","2 Unit", "BMN-KKG-008"],
        ["Laptop","Lenovo","1 Unit", "BMN-KKG-009"],
        ["Laptop","Lenovo","1 Unit", "BMN-KKG-010"],
        ["Laptop","Lenovo","1 Unit", "BMN-KKG-011"],
        ["Laptop","Lenovo","1 Unit", "BMN-KKG-012"],
        ["Meja Kerja Kantor","Donati","1 Unit", "BMN-KKG-013"],
        ["Meja Kerja Kantor","Donati","1 Unit", "BMN-KKG-014"],
        ["Printer","Epson","1 Unit", "BMN-KKG-015"],
        ["Rak Penyimpanan","Rafega","1 Unit", "BMN-KKG-016"],
        ["Rak Penyimpanan Berkas","","2 Unit", "BMN-KKG-017"],
        ["Tempat Sampah","Shimpo","1 Unit", "BMN-KKG-018"]
      ],
      "KASI_INTELEJEN_&_PENINDAKAN": [
        ["AC","Sharp","1 Unit", "BMN-KIP-001"],
        ["Brankas","Dainchi","2 Unit", "BMN-KIP-002"],
        ["Komputer","Axioo","1 Unit", "BMN-KIP-003"],
        ["Komputer","Lenovo","1 Unit", "BMN-KIP-004"],
        ["Kursi Futura Merah","Futura","1 Unit", "BMN-KIP-005"],
        ["Lemari Arsip","","1 Unit", "BMN-KIP-006"],
        ["Meja Kerja Kantor","","1 Unit", "BMN-KIP-007"]
      ],
      "KASUBSI_PENINDAKAN": [
        ["AC","Panasonic","1 Unit", "BMN-KSP-001"],
        ["Komputer AIO","HP","1 Unit", "BMN-KSP-002"],
        ["Kursi Futura","Futura","2 Unit", "BMN-KSP-003"],
        ["Kursi kantor","Preloved","1 Unit", "BMN-KSP-004"],
        ["Kursi Lipat","Flaken","1 Unit", "BMN-KSP-005"],
        ["Lemari Arsip","","1 Unit", "BMN-KSP-006"],
        ["Meja kerja","","1 Unit", "BMN-KSP-007"],
        ["Meja Kerja Kantor","Higpoint","1 Unit", "BMN-KSP-008"],
        ["Tempat Sampah","Green Leave","1 Unit", "BMN-KSP-009"]
      ],
      "KASUBSI_LALULINTAS": [
        ["AC","Samsung","1 Unit", "BMN-KSL-001"],
        ["Brankas","Indachi","1 Unit", "BMN-KSL-002"],
        ["Filing Cabinet 2 Pintu","","1 Unit", "BMN-KSL-003"],
        ["Komputer ","Acer","1 Unit", "BMN-KSL-004"],
        ["Komputer ","Axioo","1 Unit", "BMN-KSL-005"],
        ["Komputer ","Lenovo","1 Unit", "BMN-KSL-006"],
        ["Komputer ","Lenovo","1 Unit", "BMN-KSL-007"],
        ["Komputer ","Lenovo","1 Unit", "BMN-KSL-008"],
        ["Komputer ","Lenovo","1 Unit", "BMN-KSL-009"],
        ["Komputer ","Lenovo","1 Unit", "BMN-KSL-010"],
        ["Komputer ","Lenovo","1 Unit", "BMN-KSL-011"],
        ["Kursi Futura Merah","Futura","5 Unit", "BMN-KSL-012"],
        ["Kursi Kerja Kantor","Donati","1 Unit", "BMN-KSL-013"],
        ["Laci Kantor Donati","Uvixo","2 Unit", "BMN-KSL-014"],
        ["Lemari Arsip","","3 Unit", "BMN-KSL-015"],
        ["Meja Kantor","Grand Furniture","1 Unit", "BMN-KSL-016"],
        ["Printer","Epson","1 Unit", "BMN-KSL-017"],
        ["Printer","Epson L220","1 Unit", "BMN-KSL-018"],
        ["Printer Data Card","Datacard","1 Unit", "BMN-KSL-019"],
        ["Sceaner","Brother","1 Unit", "BMN-KSL-020"],
        ["Sceaner","Fujitsu","1 Unit", "BMN-KSL-021"],
        ["UPS ICA CT","ICA","1 Unit", "BMN-KSL-022"]
      ],
      "RUANG_PELAYANAN_WNI(LOKET)": [
        ["AC","Gree","2 Unit", "BMN-RPWNI-001"],
        ["AC","Polytron","1 Unit", "BMN-RPWNI-002"],
        ["Gree Air Forever","Gree","1 Unit", "BMN-RPWNI-003"],
        ["Kamera","Cannon","2 Unit", "BMN-RPWNI-004"],
        ["Komputer","Acer","2 Unit", "BMN-RPWNI-005"],
        ["Komputer ","HP","1 Unit", "BMN-RPWNI-006"],
        ["Komputer","LG","2 Unit", "BMN-RPWNI-007"],
        ["Komputer","Lenovo","3 Unit", "BMN-RPWNI-008"],
        ["Komputer","Think Centure","1 Unit", "BMN-RPWNI-009"],
        ["Komputer","Think Vision","1 Unit", "BMN-RPWNI-010"],
        ["Kursi Futura Merah","Futura","6 Unit", "BMN-RPWNI-011"],
        ["Kursi Kantor","Pargo","2 Unit", "BMN-RPWNI-012"],
        ["Lemari penyimpanan","Narkotik","1 Unit", "BMN-RPWNI-013"],
        ["Printer","Epson","1 Unit", "BMN-RPWNI-014"],
        ["Rak Penyimpanan Dokumen","Libraw Pharma","1 Unit", "BMN-RPWNI-015"],
        ["Sceaner","Cross Match","1 Unit", "BMN-RPWNI-016"],
        ["Sofa Bench","Velboa","6 Unit", "BMN-RPWNI-017"],
        ["Telepon Kantor","Panassonic","1 Unit", "BMN-RPWNI-018"],
        ["TV LED 32","LG","1 Unit", "BMN-RPWNI-019"],
        ["UPS ICA CT","ICA","1 Unit", "BMN-RPWNI-020"]
      ],
      "LOKET_STAF(LAMA)": [
        ["AC","Gree","2 Unit", "BMN-LSL-001"],
        ["AC","Polytron","1 Unit", "BMN-LSL-002"],
        ["Gree Air Forever","Gree","1 Unit", "BMN-LSL-003"],
        ["Kamera","Cannon","2 Unit", "BMN-LSL-004"],
        ["Komputer","Acer","2 Unit", "BMN-LSL-005"],
        ["Komputer ","HP","1 Unit", "BMN-LSL-006"],
        ["Komputer","LG","2 Unit", "BMN-LSL-007"],
        ["Komputer","Lenovo","3 Unit", "BMN-LSL-008"],
        ["Komputer","Think Centure","1 Unit", "BMN-LSL-009"],
        ["Komputer","Think Vision","1 Unit", "BMN-LSL-010"],
        ["Kursi Futura Merah","Futura","6 Unit", "BMN-LSL-011"],
        ["Kursi Kantor","Pargo","2 Unit", "BMN-LSL-012"],
        ["Lemari penyimpanan","Narkotik","1 Unit", "BMN-LSL-013"],
        ["Printer","Epson","1 Unit", "BMN-LSL-014"],
        ["Rak Penyimpanan Dokumen","Libraw Pharma","1 Unit", "BMN-LSL-015"],
        ["Sceaner","Cross Match","1 Unit", "BMN-LSL-016"],
        ["Sofa Bench","Velboa","6 Unit", "BMN-LSL-017"],
        ["Telepon Kantor","Panassonic","1 Unit", "BMN-LSL-018"],
        ["TV LED 32","LG","1 Unit", "BMN-LSL-019"],
        ["UPS ICA CT","ICA","1 Unit", "BMN-LSL-020"]
      ],
    };

    // ======= Utility: localStorage save/load =======
    const STORAGE_KEY = 'bmn_data_v38';

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return JSON.parse(JSON.stringify(defaultData));
      try {
        const parsed = JSON.parse(raw);
        // Pastikan data yang dimuat adalah objek dan bukan null
        if (typeof parsed === 'object' && parsed !== null) {
          // Tambahkan kolom 'Nomor Barang' jika belum ada di data yang tersimpan
          for (const room in parsed) {
            parsed[room] = parsed[room].map(item => {
              // Jika item memiliki 3 elemen (nama, merk, jumlah), tambahkan kolom kosong untuk nomor barang
              if (item.length === 3) {
                return [...item, ''];
              }
              // Jika item memiliki lebih dari 4 elemen (misal: data lama dengan format berbeda),
              // atau kurang dari 3, kita coba normalisasi ke 4 elemen.
              // Ini adalah penanganan robust untuk data yang mungkin tidak konsisten.
              while (item.length < 4) {
                item.push('');
              }
              return item.slice(0, 4); // Pastikan hanya 4 elemen yang diambil
            });
          }
          return parsed;
        }
        return JSON.parse(JSON.stringify(defaultData));
      } catch (err) {
        console.warn('Gagal parse localStorage, memakai default', err);
        return JSON.parse(JSON.stringify(defaultData));
      }
    }

    function saveData(d) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
      } catch (e) {
        console.error("Gagal menyimpan data ke localStorage:", e);
        alert("Penyimpanan data gagal. Mungkin ruang penyimpanan penuh atau browser dalam mode privat.");
      }
    }

    // ======= App state =======
    let data = loadData();

    // ======= Render functions =======
    function render() {
      const main = document.getElementById('main-content');
      main.innerHTML = '';

      // Table of contents
      const toc = document.createElement('nav');
      toc.className = 'toc';
      toc.innerHTML = `<h3>Daftar Ruangan</h3><ul></ul>`;
      const ul = toc.querySelector('ul');
      Object.keys(data).forEach(room => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + encodeURIComponent(room);
        a.innerText = room.replace(/_/g,' ');
        li.appendChild(a);
        ul.appendChild(li);
      });
      main.appendChild(toc);

      Object.keys(data).forEach(room => {
        const section = document.createElement('section');
        section.id = room;
        const count = data[room].length;
        section.innerHTML = `
          <h2>Nama Ruangan: ${room.replace(/_/g,' ')}</h2>
          <div class="meta">Jumlah entri: <span id="count-${room}">${count}</span></div>
          <form onsubmit="addItem(event,'${room}')">
            <div class="controls">
              <input name="barang" placeholder="Nama Barang" required />
              <input name="merk" placeholder="Merk" />
              <input name="jumlah" placeholder="Jumlah (contoh: 2 Unit)" required />
              <input name="nomor_barang" placeholder="Nomor Barang" />
              <button type="submit">‚ûï Tambah</button>
            </div>
          </form>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Nama Barang</th><th>Merk</th><th>Jumlah</th><th>Nomor Barang</th><th style="width:220px">Aksi</th></tr>
              </thead>
              <tbody id="tbody-${room}"></tbody>
            </table>
          </div>
          <a class="back-top" href="#top" style="display:inline-block;margin-top:10px;color:var(--accent);text-decoration:none">‚¨Ü Kembali ke atas</a>
        `;
        main.appendChild(section);
        updateTable(room);
      });
    }

    function updateTable(room) {
      const tbody = document.getElementById('tbody-' + room);
      const countEl = document.getElementById('count-' + room);
      tbody.innerHTML = '';
      data[room].forEach((row, i) => {
        const tr = document.createElement('tr');
        const nama = escapeHtml(row[0]||'');
        const merk = escapeHtml(row[1]||'');
        const jumlah = escapeHtml(row[2]||'');
        const nomor = escapeHtml(row[3] || '');

        tr.innerHTML = `
          <td data-label="Nama Barang">${nama}</td>
          <td data-label="Merk">${merk}</td>
          <td data-label="Jumlah" id="q-${room}-${i}">${jumlah}</td>
          <td data-label="Nomor Barang">${nomor}</td>
          <td class="actions">
            <button class="small" onclick="decreaseQty('${room}',${i})">‚àí</button>
            <button class="small" onclick="increaseQty('${room}',${i})">+</button>
            <button class="small" onclick="editRow('${room}',${i})">‚úè Edit</button>
            <button class="small danger" onclick="deleteRow('${room}',${i})">üóë Hapus</button>
          </td>`;
        tbody.appendChild(tr);
      });
      if (countEl) countEl.innerText = data[room].length;
      saveData(data);
    }

    // ======= CRUD ops =======
    function addItem(e, room) {
      e.preventDefault();
      const form = e.target;
      const barang = form.barang.value.trim();
      const merk = form.merk.value.trim();
      const jumlah = form.jumlah.value.trim();
      const nomor = form.nomor_barang.value.trim();
      if (!barang || !jumlah) {
        alert('Nama Barang dan Jumlah harus diisi.');
        return;
      }
      data[room].push([barang, merk, jumlah, nomor]);
      form.reset();
      updateTable(room);
    }

    function deleteRow(room, i) {
      if (!confirm('Apakah Anda yakin ingin menghapus item ini?')) return;
      data[room].splice(i,1);
      updateTable(room);
    }

    function editRow(room, i) {
      const item = data[room][i];
      let newBarang = prompt('Edit Nama Barang:', item[0]);
      if (newBarang === null) return;
      newBarang = newBarang.trim();

      let newMerk = prompt('Edit Merk:', item[1]);
      if (newMerk === null) return;
      newMerk = newMerk.trim();

      let newJumlah = prompt('Edit Jumlah:', item[2]);
      if (newJumlah === null) return;
      newJumlah = newJumlah.trim();

      let newNomor = prompt('Edit Nomor Barang:', item[3] || '');
      if (newNomor === null) return;
      newNomor = newNomor.trim();
      
      item[0] = newBarang;
      item[1] = newMerk;
      item[2] = newJumlah;
      item[3] = newNomor;
      updateTable(room);
    }

    // ======= Quantity helpers (tambah / kurangi) =======
    function parseQty(q) {
      const s = String(q).trim();
      const m = s.match(/(-?\d+(?:[.,]\d+)?)\s*(.*)/); // Menangkap angka dan unit
      if (m) {
        const numStr = m[1].replace(',', '.');
        const n = parseFloat(numStr);
        const unit = m[2] || '';
        return { n: isNaN(n) ? 0 : n, unit };
      }
      return { n: 0, unit: s }; // Jika tidak ada angka, anggap jumlah 0 dan seluruh string sebagai unit
    }

    function formatQty(n, unit) {
      if (Number.isInteger(n)) {
        return unit ? `${n} ${unit}` : `${n}`;
      } else {
        const fixed = Math.round(n * 100) / 100; // Membulatkan ke 2 desimal
        return unit ? `${fixed} ${unit}` : `${fixed}`;
      }
    }

    function increaseQty(room, i) {
      const item = data[room][i];
      const q = parseQty(item[2]);
      const newN = q.n + 1;
      item[2] = formatQty(newN, q.unit);
      updateTable(room);
    }

    function decreaseQty(room, i) {
      const item = data[room][i];
      const q = parseQty(item[2]);
      let newN = q.n - 1;
      if (newN < 0) newN = 0;
      item[2] = formatQty(newN, q.unit);
      updateTable(room);
    }

    // ======= Helpers: escape html =======
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(m){ return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

    function printPage() {
      window.print();
    }

    // ======= Download PDF Function =======
    async function downloadPdf() {
      // Pastikan jsPDF dan autoTable sudah dimuat
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.AcroForm === 'undefined') {
        alert('Library jsPDF belum dimuat. Mohon tunggu sebentar atau cek koneksi internet Anda.');
        return;
      }
      if (typeof window.jspdf.autoTable === 'undefined') {
        alert('Library jsPDF-AutoTable belum dimuat. Mohon tunggu sebentar atau cek koneksi internet Anda.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size

      // Data untuk tabel PDF
      const head = [["Ruangan", "Nama Barang", "Merk", "Jumlah", "Nomor Barang"]];
      const body = [];

      // Iterasi setiap ruangan dan tambahkan ke body tabel
      for (const room in data) {
        const roomName = room.replace(/_/g, ' ');
        data[room].forEach(item => {
          // Pastikan semua item memiliki 4 elemen (nama, merk, jumlah, nomor)
          const namaBarang = item[0] || '';
          const merk = item[1] || '';
          const jumlah = item[2] || '';
          const nomorBarang = item[3] || '';
          body.push([roomName, namaBarang, merk, jumlah, nomorBarang]);
        });
      }

      // Tambahkan judul dokumen
      doc.setFontSize(18);
      doc.text("Daftar Barang Milik Negara (BMN)", 105, 20, null, null, "center");
      doc.setFontSize(12);
      doc.text("Kantor Imigrasi Kelas II TPI Sorong", 105, 27, null, null, "center");

      // Tambahkan tabel ke PDF
      doc.autoTable({
        startY: 35, // Mulai tabel setelah judul
        head: head,
        body: body,
        theme: 'grid', // 'striped', 'grid', 'plain'
        styles: {
          fontSize: 8,
          cellPadding: 2,
          valign: 'middle',
          halign: 'left'
        },
        headStyles: {
          fillColor: [233, 236, 239], // Warna header tabel (abu-abu terang)
          textColor: [51, 51, 51], // Warna teks header (gelap)
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 35 }, // Ruangan
          1: { cellWidth: 50 }, // Nama Barang
          2: { cellWidth: 30, halign: 'center' }, // Jumlah
          3: { cellWidth: 35, halign: 'center' }  // Nomor Barang
        },
        didDrawPage: function (data) {
          // Footer halaman (nomor halaman)
          let str = "Halaman " + doc.internal.getNumberOfPages();
          doc.setFontSize(10);
          doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });

      // Simpan PDF
      doc.save('daftar_bmn.pdf');
    }

    // ======= Search / Filter =======
    function filterData(keyword) {
      keyword = keyword.toLowerCase();
      const sections = document.querySelectorAll("section");

      sections.forEach(sec => {
        let matchFound = false;

        sec.querySelectorAll("tbody tr").forEach(tr => {
          const namaBarang = tr.cells[0]?.innerText.toLowerCase() || "";
          const merk       = tr.cells[1]?.innerText.toLowerCase() || "";
          const jumlah     = tr.cells[2]?.innerText.toLowerCase() || "";
          const nomor      = tr.cells[3]?.innerText.toLowerCase() || "";

          if (
            namaBarang.includes(keyword) ||
            merk.includes(keyword) ||
            jumlah.includes(keyword) ||
            nomor.includes(keyword)
          ) {
            tr.style.display = "";
            matchFound = true;
          } else {
            tr.style.display = "none";
          }
        });

        sec.style.display = matchFound || keyword === "" ? "" : "none";
      });
    }

    document.getElementById("searchBox").addEventListener("input", e => {
      filterData(e.target.value);
    });

    // ======= Init =======
    window.addEventListener('load', () => {
      // Memastikan data diinisialisasi dengan benar saat halaman dimuat
      data = loadData();
      render();
    });
  </script>
</body>
</html>