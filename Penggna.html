<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daftar BMN - Semua Ruangan</title>
  <!-- Sertakan library jsPDF dan jsPDF-AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
  <style>
   
    :root {
      --bg: #f0f2f5; 
      --card: #ffffff; 
      --text: #333333; 
      --muted: #666666; 
      --accent: #007bff; 
      --line: #dddddd; 
      --danger: #dc3545; 
      --success: #28a745; 
    }
    
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }

    header {
      max-width: 1200px; margin: 0 auto 16px; padding: 18px; background: var(--card); border: 1px solid var(--line); border-radius: 12px;
      display:flex;
      gap: 20px; 
      align-items:center;
      justify-content: space-between; 
      flex-wrap:wrap;
    }
    header .left {
      flex-grow: 1; 
      flex-shrink: 0;
    }
    h1 { margin: 0; font-size: 20px; }
    .meta-line { color: var(--muted); font-size: 13px; margin-top:6px; }
    .controls {
      display:flex;
      gap:8px; 
      align-items:center;
      flex-wrap: wrap; 
      flex-shrink: 0; 
    }

    input[type="search"], input[type="file"] {
      padding:8px 10px; border-radius:10px; border:1px solid var(--line);
      background:#ffffff; 
      color:var(--text); 
    }

    button, .btn {
      padding:8px 10px; border-radius:10px; border:1px solid var(--line);
      background:#e9ecef; 
      color:var(--text); 
      cursor:pointer;
      white-space: nowrap; 
    }

    main { max-width: 1200px; margin: 18px auto; }

    /* START: Perubahan untuk merapikan nav.toc (rata kiri & kanan, jarak SANGAT rapat) */
    nav.toc {
      margin-bottom: 25px;
      padding: 15px 20px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    nav.toc h3 {
      margin: 0 0 12px 0;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
      border-bottom: 1px solid var(--line);
      padding-bottom: 8px;
      text-align: left; 
    }
    nav.toc ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 4px; 
      justify-content: space-between; 
    }
    nav.toc li {
      flex: 0 1 auto;
      max-width: none; 
      flex: 1 1 auto; 
    }
    nav.toc a {
      color: var(--accent);
      text-decoration: none;
      padding: 8px 8px;
      background: #eef4f8;
      border-radius: 10px;
      display: block; 
      border: 1px solid #d0e0ea;
      transition: all 0.2s ease;
      font-size: 14px;
      text-align: left;
      white-space: normal; 
      overflow: visible; 
      text-overflow: clip; 
      height: auto; 
    }
    nav.toc a:hover {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }

    @media (max-width: 640px) {
      nav.toc ul {
        flex-direction: column; 
        align-items: stretch; 
      }
      nav.toc li {
        width: 100%; 
        max-width: 100%; 
      }
      nav.toc a {
        width: 100%;
        text-align: center;
        white-space: normal; 
      }
    }
    /* END: Perubahan untuk merapikan nav.toc (rata kiri & kanan, jarak SANGAT rapat) */

    section {
      background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 12px; margin-bottom: 14px;
    }
    section h2 { margin: 0 0 8px 0; font-size: 16px; }
    .meta { color:var(--muted); font-size:13px; margin-bottom:8px; }

    .table-wrap { overflow-x:auto; } 
    table { width:100%; border-collapse: collapse; }
    thead th {
      position: sticky; top:0;
      background:#e9ecef;
      z-index:2;
      text-align: center;
    }
    th, td { border-bottom:none; padding:8px 10px; text-align:left; }
    tbody tr:hover {
      background:#f8f9fa;
    }

    .hidden { display:none !important; }
    form .controls {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
      justify-content: flex-start;
    }
    form input, form button {
      flex: 1; 
      min-width: 120px; 
    }
    .actions {
      display: flex;
      gap: 6px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap; 
    }
    .actions button {
      margin-right: 0;
      min-width: 70px;
      flex: 1 1 auto; 
    }
    .small { padding:6px 8px; font-size:13px; border-radius:8px; }
    .danger {
      background:#e9ecef;
      border-color:rgba(0,0,0,0.05);
      color: #000000;
    }
    .success { background:var(--success); border-color:rgba(0,0,0,0.05); }

    footer { max-width:1200px; margin:8px auto 40px auto; color:var(--muted); font-size:12px; text-align:center; }
    .utils { display:flex; gap:8px; align-items:center; }

    /* CSS untuk merata-tengahkan semua kolom data */
    td:nth-child(1), 
    td:nth-child(2),
    td:nth-child(3), 
    td:nth-child(4) { 
      text-align: center;
    }

    @media (max-width:640px) {
      body { padding: 10px; } 
      header { padding:12px; flex-direction: column; align-items: flex-start; } 
      header .controls { width: 100%; justify-content: center; margin-top: 10px; } 
      header .controls input, header .controls button { flex: 1 1 100%; } 

      form input, form button { flex:1 1 100%; } 
      td.actions {
        padding-left: 6px;
        text-align: center;
        display: flex;
        flex-direction: column; 
        justify-content: center;
        gap: 4px; 
        min-width: 80px;
      }
      td.actions button {
        width: 100%; 
        min-width: unset; 
      }
    }

    @media print {
      @page {
        size: A4 portrait;
        margin: 15mm;
        @bottom-center {
          content: counter(page);
          font-size: 10pt;
          font-family: "Times New Roman", Times, serif;
        }
      }
      body {
        background: #fff !important;
        color: #000 !important;
        font-size: 11pt !important;
      }
      header, footer, .controls, .back-top, button#printBtn {
        display: none !important;
      }
      header {
        display: block !important;
        background: #fff !important;
        color: #000 !important;
        border: none !important;
        margin-bottom: 20px !important;
        text-align: center !important;
      }
      header h1 {
        font-size: 18pt !important;
        font-weight: bold !important;
        margin: 0 0 20px 0 !important;
      }
      nav.toc {
        display: block !important;
        margin-bottom: 20px !important;
      }
      #main-content section {
        margin-bottom: 8px !important;
        page-break-inside: avoid;
      }
      table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin-bottom: 15px !important;
        table-layout: fixed !important;
      }
      th, td {
        border: 2px solid #000 !important;
        background-color: #ffffff !important;
        padding: 6px 10px !important;
        line-height: 1.4 !important;
        vertical-align: top !important;
        word-wrap: break-word !important;
      }
      th {
        background: #e6e6e6 !important;
        font-weight: bold !important;
        text-align: center !important;
      }
     
      table tr > th:nth-child(5),
      table tr > td:nth-child(5) {
        display: none !important; 
      }
  
      td:nth-child(3) { 
        text-align: center !important;
      }
      td:nth-child(4) { 
        text-align: center !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>üìã Daftar BMN ‚Äì Semua Ruangan </h1>
      <div class="meta-line">Mode: Pengguna</div>
    </div>
    <div class="controls">
      <input type="search" id="searchBox" placeholder="üîç Cari barang atau ruangan..." />
      <button onclick="printPage()">üñ® Cetak</button>
      <button onclick="downloadPdf()">‚¨áÔ∏è Unduh PDF</button>
    </div>
  </header>

  <main id="main-content"></main>

  <footer>Kantor Imigrasi Kelas II TPI Sorong</footer>

  <script>
    // ======= Data default (diambil dari file awal) =======
    const defaultData = {
      "KEPALA_KANTOR": [
        ["AC","Gree","2 Unit",""],
        ["Fire Extinguisher","","2 Unit",""],
        ["Kursi Futura","Futura","36 Unit",""],
        ["Layar Monitor","Sony","1 Unit",""],
        ["Meja Kayu","","2 Unit",""],
        ["Meja Lipat","Food Crout","8 Unit",""],
        ["Meja Sofa","","1 Unit",""],
        ["Sofa","","1 Set",""],
        ["Speaker","Lexu","4 Unit",""]
      ],
      "AULA": [
        ["AC","Gree","2 Unit",""],
        ["Fire extinguisher","","2 Unit",""],
        ["Kursi Futere","Futere","36 Unit",""],
        ["Layar Monitor","Sony","1 Unit",""],
        ["Meja Kayu","","2 Unit",""],
        ["Meja Lipat","Food Crout","8 Unit",""],
        ["Meja Sofa","","1 Unit",""],
        ["Sofa","","1 Set",""],
        ["Speaker","Lexu","4 Unit",""]
      ],
      "KASI_INTELEJEN_&_PENINDAKAN": [
        ["AC","Sharp","1 Unit",""],
        ["Brankas","Dainchi","2 Unit",""],
        ["Komputer","Axioo","1 Unit",""],
        ["Komputer","Lenovo","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Lemari Arsip","","1 Unit", ""],
        ["Meja Kerja Kantor","","1 Unit",""]
      ],
      "KASUBSI_INTELEJEN": [
        ["Komputer AIO","Hp","1 Unit",""],
        ["Kursi Future Merah","Future","2 Unit",""],
        ["Kursi Kerja Kantor","Indhaci","1 Unit",""],
        ["Meja Kerja Kantor","","2 Unit",""],
        ["Rak Penyimpanan Barang","","1 Unit",""]
      ],
      "KASUBSI_PENINDAKAN": [
        ["AC","Panasonic","1 Unit",""],
        ["Komputer AIO","HP","1 Unit",""],
        ["Kursi Futura","Futura","2 Unit",""],
        ["Kursi kantor","Preloved","1 Unit",""],
        ["Kursi Lipat","Flaken","1 Unit",""],
        ["Lemari Arsip","","1 Unit",""],
        ["Meja kerja","","1 Unit",""],
        ["Meja Kerja Kantor","Higpoint","1 Unit",""],
        ["Tempat Sampah","Green Leave","1 Unit",""]
      ],
      "KASI_TEKNOLOGI_INFORMASI_&_KOMUNIKASI(TIKIM)": [ 
        ["AC Spilit","Sharp","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Kursi Kerja","Indachi","1 Unit",""],
        ["Kursi Kerja","Donati","1 Unit",""],
        ["Lemari arsip Besi","Brother","1 Unit",""],
        ["Meja Kantor","Fantasi","1 Unit",""],
        ["Meja Rapat Kantor","Brother","1 Unit",""],
        ["Monitor Komputer","ACER","1 Unit",""],
        ["Tempat Sampah","","1 Unit",""],
        ["Whit board","","1 Unit",""],
        ["Speaker","","1 Unit",""]
      ],
      "KAUR_UMUM": [
        ["Komputer","Axioo","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Kursi Kerja Kantor","Indachi","2 Unit",""],
        ["Lemari Arsip besi","","1 Unit",""],
        ["Meja Kerja Kantor","","1 Unit",""]
      ],
      "KASUBAG_TATA_USAHA": [
        ["AC","Polytron","1 Unit",""],
        ["Brankas","Indachi","1 Unit",""],
        ["Brankas","Indachi","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Lemari Besi","LG","1 Unit",""],
        ["Lemari Kabinet","LG","1 Unit",""],
        ["Meja Kerja","","1 Unit",""]
      ],
      "KAUR_KEPEGAWAIAN": [
        ["AC","Samsung","1 Unit",""],
        ["Brankas","","1 Unit",""],
        ["Kursi Futura Merah","Futura","2 Unit",""],
        ["Lemari kabinet","LG","1 Unit",""],
        ["Meja kerja","","1 Unit",""],
        ["Rak Besi","Lion","1 Unit",""]
      ],
      "KAUR_KEUANGAN": [
        ["AC","Samsung","1 Unit",""],
        ["Brankas","Dragon A1 Lk","1 Unit",""],
        ["Cermin","","1 Unit",""],
        ["Jam Dinding","","1 Unit",""],
        ["Komputer","Axioo","1 Unit",""],
        ["Komputer AIO","HP","1 Unit",""],
        ["Kursi Futura Merah","Futura","2 Unit",""],
        ["Kursi Kantor","Indhachi","2 Unit",""],
        ["Laptop","Lenovo","1 Unit",""],
        ["Laptop","Lenovo","1 Unit",""],
        ["Laptop","Lenovo","1 Unit",""],
        ["Laptop","Lenovo","1 Unit",""],
        ["Meja Kerja Kantor","Donati","1 Unit",""],
        ["Meja Kerja Kantor","Donati","1 Unit",""],
        ["Printer","Epson","1 Unit",""],
        ["Rak Penyimpanan","Rafega","1 Unit",""],
        ["Rak Penyimpanan Berkas","","2 Unit",""],
        ["Tempat Sampah","Shimpo","1 Unit",""]
      ],
      "DAPUR": [
        ["Dispenser","Miyako","1 Unit",""],
        ["Freezer","","1 Unit",""],
        ["Kulkas","LG","1 Unit",""],
        ["Kursi Futura Merah","Futura","2 Unit",""],
        ["Kursi Lipat Bangku","","1 Unit",""],
        ["Kitchen Shet","","1 Unit",""],
        ["Lemari Arsip Besi","Brother","1 Unit",""],
        ["Meja Dapur","","1 Unit",""],
        ["Meja Makan","Informa","1 Unit",""]
      ],
      "RUANG_RAPAT": [
        ["AC","Sharp","1 Unit",""],
        ["Kursi Futura Merah","Futura","8 Unit",""],
        ["Kursi kerja kantor","Indachi","1 Unit",""],
        ["Meja kerja Bundah","Indachi","1 Unit",""],
        ["TV SONY","SONY BRAVIA","1 Unit",""]
      ],
      "RUANG_ISTIRAHAT": [
        ["AC","Polytron","1 Unit",""],
        ["Brankas","Lexto","1 Unit",""],
        ["Kursi kantor Coklat","Indachi","1 Unit",""],
        ["Lemari Arsip Besi","Tiger","1 Unit",""],
        ["Sofa Classic","Classic","1 Set",""],
        ["Sound System","Geisler","1 Unit",""],
        ["Speakers","BMB","2 Unit",""],
        ["Rak Penyimpanan","","1 Unit", ""]
      ],
      "LOKET_STAF(LAMA)": [
        ["AC","Gree","2 Unit",""],
        ["AC","Polytron","1 Unit",""],
        ["Gree Air Forever","Gree","1 Unit",""],
        ["Kamera","Cannon","2 Unit",""],
        ["Komputer","Acer","2 Unit",""],
        ["Komputer ","HP","1 Unit",""],
        ["Komputer","LG","2 Unit",""],
        ["Komputer","Lenovo","3 Unit",""],
        ["Komputer","Think Centure","1 Unit",""],
        ["Komputer","Think Vision","1 Unit",""],
        ["Kursi Futura Merah","Futura","6 Unit",""],
        ["Kursi Kantor","Pargo","2 Unit",""],
        ["Lemari penyimpanan","Narkotik","1 Unit",""],
        ["Printer","Epson","1 Unit",""],
        ["Rak Penyimpanan Dokumen","Libraw Pharma","1 Unit", ""],
        ["Sceaner","Cross Match","1 Unit",""],
        ["Sofa Bench","Velboa","6 Unit",""],
        ["Telepon Kantor","Panassonic","1 Unit",""],
        ["TV LED 32","LG","1 Unit",""],
        ["UPS ICA CT","ICA","1 Unit",""]
      ],
      "RUANG_PELAYANAN_WNA": [
        ["AC","Samsung","1 Unit",""],
        ["Brankas","i Safe","1 Unit",""],
        ["Komputer","Acer","1 Unit",""],
        ["Komputer","Axioo","1 Unit",""],
        ["Kursi Kerja Kantor","","5 Unit",""],
        ["Lemari Arsip Besi","Brother","1 Unit",""],
        ["Lemari kaca","","1 Unit",""],
        ["Printer","Epson L5290","1 Unit",""],
        ["Sceaner","Fujitsu","1 Unit",""],
        ["Tempat Sampah","Multindo","1 Unit",""]
      ],
      "RUANG_PELAYANAN_WNI": [
        ["AC","Samsung","1 Unit",""],
        ["Brankas","i Safe","1 Unit",""],
        ["Komputer","Acer","1 Unit",""],
        ["Komputer","Axioo","1 Unit",""],
        ["Kursi Kerja Kantor","","5 Unit",""],
        ["Lemari Arsip Besi","Brother","1 Unit",""],
        ["Lemari kaca","","1 Unit",""],
        ["Printer","Epson L5290","1 Unit",""],
        ["Sceaner","Fujitsu","1 Unit",""],
        ["Tempat Sampah","Multindo","1 Unit",""]
      ],
      "KASI_LALULINTAS": [
        ["AC","Sharp","1 Unit",""],
        ["Brankas","Dainchi","2 Unit",""],
        ["Komputer","Axioo","1 Unit",""],
        ["Komputer","Lenovo","1 Unit",""],
        ["Kursi Futura Merah","Futura","1 Unit",""],
        ["Lemari Arsip","","1 Unit", ""],
        ["Meja Kerja Kantor","","1 Unit",""]
      ],
      "KASUBSI_LALULINTAS": [
        ["AC","Samsung","1 Unit",""],
        ["Brankas","Indachi","1 Unit",""],
        ["Filing Cabinet 2 Pintu","","1 Unit",""],
        ["Komputer ","Acer","1 Unit",""],
        ["Komputer ","Axioo","1 Unit",""],
        ["Komputer ","Lenovo","1 Unit",""],
        ["Komputer ","Lenovo","1 Unit",""],
        ["Komputer ","Lenovo","1 Unit",""],
        ["Komputer ","Lenovo","1 Unit",""],
        ["Komputer ","Lenovo","1 Unit",""],
        ["Kursi Futura Merah","Futura","5 Unit",""],
        ["Kursi Kerja Kantor","Donati","1 Unit",""],
        ["Laci Kantor Donati","Uvixo","2 Unit",""],
        ["Lemari Arsip","","3 Unit",""],
        ["Meja Kantor","Grand Furniture","1 Unit",""],
        ["Printer","Epson","1 Unit",""],
        ["Printer","Epson L220","1 Unit",""],
        ["Printer Data Card","Datacard","1 Unit",""],
        ["Sceaner","Brother","1 Unit",""],
        ["Sceaner","Fujitsu","1 Unit",""],
        ["UPS ICA CT","ICA","1 Unit",""]
      ],
      "RUANG_PERCETAKAN_PASPOR": [
        ["AC","Sharp","1 Unit",""],
        ["Kursi Futura Merah","Futura","8 Unit",""],
        ["Kursi kerja kantor","Indachi","1 Unit",""],
        ["Meja kerja Bundah","Indachi","1 Unit",""],
        ["TV SONY","SONY BRAVIA","1 Unit",""]
      ],
      "RUANG_PENGADUAN": [
        ["AC","Polytron","1 Unit",""],
        ["Brankas","Lexto","1 Unit",""],
        ["Kursi kantor Coklat","Indachi","1 Unit",""],
        ["Lemari Arsip Besi","Tiger","1 Unit",""],
        ["Sofa Classic","Classic","1 Set",""],
        ["Sound System","Geisler","1 Unit",""],
        ["Speakers","BMB","2 Unit",""],
        ["Rak Penyimpanan","","1 Unit", ""]
      ],
      "STAF_LALIN(LALULINTAS)": [
        ["AC","Gree","2 Unit",""],
        ["AC","Polytron","1 Unit",""],
        ["Gree Air Forever","Gree","1 Unit",""],
        ["Kamera","Cannon","2 Unit",""],
        ["Komputer","Acer","2 Unit",""],
        ["Komputer ","HP","1 Unit",""],
        ["Komputer","LG","2 Unit",""],
        ["Komputer","Lenovo","3 Unit",""],
        ["Komputer","Think Centure","1 Unit",""],
        ["Komputer","Think Vision","1 Unit",""],
        ["Kursi Futura Merah","Futura","6 Unit",""],
        ["Kursi Kantor","Pargo","2 Unit",""],
        ["Lemari penyimpanan","Narkotik","1 Unit",""],
        ["Printer","Epson","1 Unit",""],
        ["Rak Penyimpanan Dokumen","Libraw Pharma","1 Unit", ""],
        ["Sofa Bench","Velboa","6 Unit",""],
        ["Telepon Kantor","Panassonic","1 Unit",""],
        ["TV LED 32","LG","1 Unit",""],
        ["UPS ICA CT","ICA","1 Unit",""]
      ],
    };

    // ======= Utility: localStorage save/load =======
    const STORAGE_KEY = 'bmn_data_v 43';

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return JSON.parse(JSON.stringify(defaultData));
      try {
        const parsed = JSON.parse(raw);
        
        if (typeof parsed === 'object' && parsed !== null) {
          
          for (const room in parsed) {
            parsed[room] = parsed[room].map(item => {
              
              if (item.length === 3) {
                return [...item, ''];
              }
             
              while (item.length < 4) {
                item.push('');
              }
              return item.slice(0, 4); 
            });
          }
          return parsed;
        }
        return JSON.parse(JSON.stringify(defaultData));
      } catch (err) {
        console.warn('Gagal parse localStorage, memakai default', err);
        return JSON.parse(JSON.stringify(defaultData));
      }
    }

    // ======= App state =======
    let data = loadData();

    // Fungsi pembantu untuk membuat ID HTML yang aman
    function createSafeId(roomName) {
      let safeId = roomName.replace(/[^a-zA-Z0-9_]/g, '_');
      safeId = safeId.replace(/_+/g, '_');
      safeId = safeId.replace(/^_|_$/g, '');
      if (safeId.match(/^\d/)) {
        safeId = '_' + safeId;
      }
      return safeId;
    }

    // ======= Render functions =======
    function render() {
      const main = document.getElementById('main-content');
      main.innerHTML = '';

      // Table of contents
      const toc = document.createElement('nav');
      toc.className = 'toc';
      toc.innerHTML = `<h3>Daftar Ruangan</h3><ul></ul>`;
      const ul = toc.querySelector('ul');
      Object.keys(data).forEach(room => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        const safeRoomId = createSafeId(room);
        a.href = '#' + safeRoomId;
        a.innerText = room.replace(/_/g,' ');
        li.appendChild(a);
        ul.appendChild(li);
      });
      main.appendChild(toc);

      Object.keys(data).forEach(room => {
        const section = document.createElement('section');
        const safeRoomId = createSafeId(room);
        section.id = safeRoomId;
        const count = data[room].length;
        section.innerHTML = `
          <h2>Nama Ruangan: ${room.replace(/_/g,' ')}</h2>
          <div class="meta">Jumlah entri: <span id="count-${room}">${count}</span></div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Nama Barang</th><th>Merk</th><th>Jumlah</th><th>Nomor Barang</th></tr>
              </thead>
              <tbody id="tbody-${room}"></tbody>
            </table>
          </div>
          <a class="back-top" href="#top" style="display:inline-block;margin-top:10px;color:var(--accent);text-decoration:none">‚¨Ü Kembali ke atas</a>
        `;
        main.appendChild(section);
        updateTable(room);
      });
    }

    function updateTable(room) {
      const tbody = document.getElementById('tbody-' + room);
      const countEl = document.getElementById('count-' + room);
      tbody.innerHTML = '';
      data[room].forEach((row, i) => {
        const tr = document.createElement('tr');
        const nama = escapeHtml(row[0]||'');
        const merk = escapeHtml(row[1]||'');
        const jumlah = escapeHtml(row[2]||'');
        const nomor = escapeHtml(row[3] || '');

        tr.innerHTML = `
          <td data-label="Nama Barang">${nama}</td>
          <td data-label="Merk">${merk}</td>
          <td data-label="Jumlah">${jumlah}</td>
          <td data-label="Nomor Barang">${nomor}</td>`;
        tbody.appendChild(tr);
      });
      if (countEl) countEl.innerText = data[room].length;
      // Tidak ada saveData di sini
    }

    // ======= Helpers: escape html =======
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(m){ return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

    function printPage() {
      window.print();
    }

    // ======= Download PDF Function =======
    async function downloadPdf() {
      
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.AcroForm === 'undefined') {
        alert('Library jsPDF belum dimuat. Mohon tunggu sebentar atau cek koneksi internet Anda.');
        return;
      }
      if (typeof window.jspdf.autoTable === 'undefined') {
        alert('Library jsPDF-AutoTable belum dimuat. Mohon tunggu sebentar atau cek koneksi internet Anda.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4'); 

      // Data untuk tabel PDF
      const head = [["Ruangan", "Nama Barang", "Merk", "Jumlah", "Nomor Barang"]];
      const body = [];

      for (const room in data) {
        const roomName = room.replace(/_/g, ' ');
        data[room].forEach(item => {
          
          const namaBarang = item[0] || '';
          const merk = item[1] || '';
          const jumlah = item[2] || '';
          const nomorBarang = item[3] || '';
          body.push([roomName, namaBarang, merk, jumlah, nomorBarang]);
        });
      }
      
      doc.setFontSize(18);
      doc.text("Daftar Barang Milik Negara (BMN)", 105, 20, null, null, "center");
      doc.setFontSize(12);
      doc.text("Kantor Imigrasi Kelas II TPI Sorong", 105, 27, null, null, "center");
      
      doc.autoTable({
        startY: 35, 
        head: head,
        body: body,
        theme: 'grid', 
        styles: {
          fontSize: 8,
          cellPadding: 2,
          valign: 'middle',
          halign: 'left'
        },
        headStyles: {
          fillColor: [233, 236, 239], 
          textColor: [51, 51, 51], 
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 35 }, 
          1: { cellWidth: 50 }, 
          2: { cellWidth: 30, halign: 'center' }, 
          3: { cellWidth: 35, halign: 'center' }  
        },
        didDrawPage: function (data) {
          
          let str = "Halaman " + doc.internal.getNumberOfPages();
          doc.setFontSize(10);
          doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });

      // Simpan PDF
      doc.save('daftar_bmn.pdf');
    }

    // ======= Search / Filter =======
    function filterData(keyword) {
      keyword = keyword.toLowerCase();
      const sections = document.querySelectorAll("section");
      const tocLinks = document.querySelectorAll("nav.toc ul li");

      sections.forEach(sec => {
        const originalRoomKey = Object.keys(data).find(key => createSafeId(key) === sec.id);
        const roomNameForSearch = originalRoomKey ? originalRoomKey.toLowerCase().replace(/_/g, ' ') : '';
        
        const roomMatchesKeyword = roomNameForSearch.includes(keyword);

        let matchFoundInItems = false;

        sec.querySelectorAll("tbody tr").forEach(tr => {
          const namaBarang = tr.cells[0]?.innerText.toLowerCase() || "";
          const merk       = tr.cells[1]?.innerText.toLowerCase() || "";
          const jumlah     = tr.cells[2]?.innerText.toLowerCase() || "";
          const nomor      = tr.cells[3]?.innerText.toLowerCase() || "";

          if (roomMatchesKeyword) {
            tr.style.display = "";
            matchFoundInItems = true;
          } else if (
            namaBarang.includes(keyword) ||
            merk.includes(keyword) ||
            jumlah.includes(keyword) ||
            nomor.includes(keyword)
          ) {
            tr.style.display = "";
            matchFoundInItems = true;
          } else {
            tr.style.display = "none";
          }
        });

        if (roomMatchesKeyword || matchFoundInItems || keyword === "") {
          sec.style.display = "";
        } else {
          sec.style.display = "none";
        }
      });

      tocLinks.forEach(li => {
          const linkText = li.querySelector('a').innerText.toLowerCase();
          if (linkText.includes(keyword) || keyword === "") {
              li.style.display = "";
          } else {
              li.style.display = "none";
          }
      });
    }

    document.getElementById("searchBox").addEventListener("input", e => {
      filterData(e.target.value);
    });

    // ======= Init =======
    window.addEventListener('load', () => {
      data = loadData();
      render();
    });
  </script>
</body>
</html>